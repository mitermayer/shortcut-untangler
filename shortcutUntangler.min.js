!function(e,t){"function"==typeof define&&define.amd?define(t):e.ShortcutUntangler=t()}(this,function(){"use scrict";var e=["alt","ctrl","shift"],t={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},n=function(e){return"number"==typeof e},r=function(e){return"string"==typeof e},i=function(e){return Array.isArray(e)},o=function(e,t){return e.every(function(e){return"undefined"!=typeof t[e]})},a=function(){},f=function(e,t){for(var n,r=e.length,i=t.weight,o=e.length-1;o>=0;o--){if(n=e[o],i===n.weight){r=o+1;break}if(i<n.weight){r=o;break}}return r},c=function(e,t){for(var n,r=0,i=0,o=e.length;o>i;i++)if(n=e[i],n.name===t){r=i;break}return r},s=function(e){for(var t={},n=e.context.length-1;n>=0;n--){var r,i=e.context[n].shortcut;for(r in i){var o=i[r];t[r]||o.disabled||(t[r]=o)}}return t},u={getKeyName:function(e){if(i(e)){for(var r=[],o=0,a=e.length;a>o;o++)r.push(this.getKeyName(e[o]));e=r.join(" ")}else n(e)?e=t[e]||String.fromCharCode(e):-1!==e.indexOf(" ")&&(e=e.toLowerCase().split(" ").filter(function(e){return e}).sort().join("+"));return e.toUpperCase()},validate:function(e,t){if(t[e.key])throw new Error('Shortcut key "'+e.key+'" is already set on context this context');if(!e||!o(["key","callback"],e))throw new Error("InvalidArguments");return!0},create:function(e){var t={key:e.key,description:e.description||"Keyboard shortcut handler triggered by key: "+e.key,name:e.name||"Shortcut for: "+e.key,callback:e.callback};return Object.defineProperty(t,"toggleDisabledState",{value:function(e){e="undefined"!=typeof e?e:!this.disabled,e?this.disabled=!0:delete this.disabled},writable:!1,enumerable:!1,configurable:!1}),t}},l={validate:function(e,t){var n=t.context[c(t.context,e.name)];if(n&&n.name===e.name)throw new Error('Context name "'+e.name+'" is already set on environment "'+t.name+'"');if(!e||!o(["name"],e))throw new Error("InvalidArguments");return!0},create:function(e){var t={shortcut:{},name:e.name,weight:e.weight||0};return Object.defineProperty(t,"toggleDisabledState",{value:function(e,t){var n;if(i(t))for(var o=0,a=t.length;a>o;o++)n=this.shortcut[t[o]],"undefined"!=typeof n&&n.toggleDisabledState(e);else if(r(t))n=this.shortcut[t],"undefined"!=typeof n&&n.toggleDisabledState(e);else for(var f in this.shortcut)this.shortcut[f].toggleDisabledState(e)},writable:!1,enumerable:!1,configurable:!1}),t}},d={validate:function(e,t){if(t[e.name])throw new Error('Environment name "'+e.name+'" is already set');if(!e||!o(["name"],e))throw new Error("InvalidArguments");return!0},create:function(e){var t={context:[],name:e.name};return Object.defineProperty(t,"toggleDisabledState",{value:function(e,t,n){var o;if(i(t))for(var a=0,f=this.context.length;f>a;a++)o=this.context[a],-1!==t.indexOf(o.name)&&o.toggleDisabledState(e,n);else if(r(t))for(var c=0,s=this.context.length;s>c;c++)o=this.context[c],o.name===t&&o.toggleDisabledState(e,n);else for(var u=0,l=this.context.length;l>u;u++)o=this.context[u],o.toggleDisabledState(e,n)},writable:!1,enumerable:!1,configurable:!1}),t}};return function(n){n=n||{};var o=n.mainEnvironment||"main",h=n.mainContext||"main",g=o,m=!1||n.debug,v=n.rootElement||document.getElementsByTagName("body")[0],y={},p={ENVIRONMENT:{}},b=function(){var e={};return{getKeys:function(){return Object.keys(e).sort().join("+")},keyDown:function(t){e[t]=!0},keyUp:function(t){delete e[t]},clear:function(){e={}}}}();this.changeEnvironment=function(e){y[e]&&(g=e)},this.debugMode=function(e){m="undefined"!=typeof e?e:!0},this.toggleDisabledState=function(e,t,n,o){var a;if(i(t))for(var f=0,c=t.length;c>f;f++)a=y[t[f]],"undefined"!=typeof a&&(a.toggleDisabledState(e,n,o),p.ENVIRONMENT[a.name]=this.toJSON(a.name));else if(r(t))a=y[t],"undefined"!=typeof a&&(a.toggleDisabledState(e,n,o),p.ENVIRONMENT[a.name]=this.toJSON(a.name));else for(a in y)y[a].toggleDisabledState(e,n,o),p.ENVIRONMENT[a]=this.toJSON(a)},this.getActiveEnvironment=function(){return g},this.toJSON=function(e){var t={};if(r(e))t="undefined"!=typeof y[e]?s(y[e]):t;else if(i(e)){t=[];for(var n=0,o=e.length;o>n;n++)t.push(s(y[e[n]]))}else if(e===!0){t=[];for(var a in y)t.push(s(y[a]))}else t=s(y[g]);return t},this.createContext=function(e,t){var n,r,i=y[t]||y[this.getActiveEnvironment()];l.validate(e,i),r=i.context,n=l.create(e),r.splice(f(r,n),0,n),p.ENVIRONMENT[i.name]=this.toJSON(i.name)},this.createEnvironment=function(e,t){var n,r="undefined"!=typeof t?t:o;d.validate(e,y),n=d.create(e),y[e.name]=n,this.createContext({name:h},e.name),r!==!1&&(n.context[0].shortcut=this.toJSON(r)),p.ENVIRONMENT[n.name]=this.toJSON(n.name)},this.createShortcut=function(e,t,n){var r=y[n||this.getActiveEnvironment()],i=c(r.context,t),o=r.context[i].shortcut;e.key=u.getKeyName(e.key),u.validate(e,o),o[e.key]=u.create(e),p.ENVIRONMENT[r.name]=this.toJSON(r.name)},this.createEnvironment({name:g}),v.addEventListener("blur",function(){b.clear()}),v.addEventListener("keyup",function(n){for(var r=n.keyCode?n.keyCode:n.which,i="undefined"!=typeof t[r]?t[r].toUpperCase():String.fromCharCode(r),o=0,a=e.length;a>o;o++){var f=e[o];n[f+"Key"]||b.keyUp(f.toUpperCase())}b.keyUp(i)},!1),v.addEventListener("keydown",function(n){var r,i,o=n.keyCode?n.keyCode:n.which,f="undefined"!=typeof t[o]?t[o].toUpperCase():String.fromCharCode(o),c=p.ENVIRONMENT[g];if(b.keyDown(f),-1===e.indexOf(f.toLowerCase()))for(var s=0,u=e.length;u>s;s++){var l=e[s];n[l+"Key"]&&b.keyDown(l.toUpperCase())}r=b.getKeys(),i=c[r],i&&(n.preventDefault(),n.stopPropagation(),m&&a(i),i.callback(n,arguments))},!1)}});