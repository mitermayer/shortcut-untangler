!function(e,t){"function"==typeof define&&define.amd?define("ShortcutUntangler",[],t):e.ShortcutUntangler=t()}(this,function(){"use scrict";var e=["alt","ctrl","shift"],t={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},n=function(e){return"string"==typeof e},r=function(e){return Array.isArray(e)},o=function(e,t){return e.every(function(e){return"undefined"!=typeof t[e]})},i=function(){},a=function(e,t){for(var n,r=e.length,o=t.weight,i=e.length-1;i>=0;i--){if(n=e[i],o===n.weight){r=i+1;break}if(o<n.weight){r=i;break}}return r},f=function(e,t){for(var n,r=0,o=0,i=e.length;i>o;o++)if(n=e[o],n.name===t){r=o;break}return r},c=function(e){for(var t={},n=e.context.length-1;n>=0;n--){var r,o=e.context[n].shortcut;for(r in o){var i=o[r];t[r]||i.disabled||(t[r]=i)}}return t},u={getKeyName:function(e){return"number"==typeof e&&(e=t[e]||String.fromCharCode(e)),-1!==e.indexOf(" ")&&(e=e.toLowerCase().split(" ").filter(function(e){return e}).sort().join("+")),e.toUpperCase()},validate:function(e,t){if(t[e.key])throw new Error('Shortcut key "'+e.key+'" is already set on context this context');if(!e||!o(["key","callback"],e))throw new Error("InvalidArguments");return!0},create:function(e){var t={key:e.key,description:e.description||"Keyboard shortcut handler triggered by key: "+e.key,name:e.name||"Shortcut for: "+e.key,callback:e.callback};return Object.defineProperty(t,"toggleDisabledState",{value:function(e){e="undefined"!=typeof e?e:!this.disabled,e?this.disabled=!0:delete this.disabled},writable:!1,enumerable:!1,configurable:!1}),t}},s={validate:function(e,t){var n=t.context[f(t.context,e.name)];if(n&&n.name===e.name)throw new Error('Context name "'+e.name+'" is already set on environment "'+t.name+'"');if(!e||!o(["name"],e))throw new Error("InvalidArguments");return!0},create:function(e){var t={shortcut:{},name:e.name,weight:e.weight||0};return Object.defineProperty(t,"toggleDisabledState",{value:function(e,t){var o;if(r(t))for(var i=0,a=t.length;a>i;i++)o=this.shortcut[t[i]],"undefined"!=typeof o&&o.toggleDisabledState(e);else if(n(t))o=this.shortcut[t],"undefined"!=typeof o&&o.toggleDisabledState(e);else for(var f in this.shortcut)this.shortcut[f].toggleDisabledState(e)},writable:!1,enumerable:!1,configurable:!1}),t}},l={validate:function(e,t){if(t[e.name])throw new Error('Environment name "'+e.name+'" is already set');if(!e||!o(["name"],e))throw new Error("InvalidArguments");return!0},create:function(e){var t={context:[],name:e.name};return Object.defineProperty(t,"toggleDisabledState",{value:function(e,t,o){var i;if(r(t))for(var a=0,f=this.context.length;f>a;a++)i=this.context[a],-1!==t.indexOf(i.name)&&i.toggleDisabledState(e,o);else if(n(t))for(var c=0,u=this.context.length;u>c;c++)i=this.context[c],i.name===t&&i.toggleDisabledState(e,o);else for(var s=0,l=this.context.length;l>s;s++)i=this.context[s],i.toggleDisabledState(e,o)},writable:!1,enumerable:!1,configurable:!1}),t}};return function(o){o=o||{};var d=o.mainEnvironment||"main",h=o.mainContext||"main",g=d,v=!1||o.debug,y=o.rootElement||document.getElementsByTagName("body")[0],m={},b=function(){var e={};return{getKeys:function(){return Object.keys(e).sort().join("+")},keyDown:function(t){e[t]=!0},keyUp:function(t){delete e[t]},clear:function(){e={}}}}();this.changeEnvironment=function(e){m[e]&&(g=e)},this.debugMode=function(e){v="undefined"!=typeof e?e:!0},this.toggleDisabledState=function(e,t,o,i){var a;if(r(t))for(var f=0,c=t.length;c>f;f++)a=m[t[f]],"undefined"!=typeof a&&a.toggleDisabledState(e,o,i);else if(n(t))a=m[t],"undefined"!=typeof a&&a.toggleDisabledState(e,o,i);else for(a in m)m[a].toggleDisabledState(e,o,i)},this.getActiveEnvironment=function(){return g},this.toJSON=function(e){var t={};if(n(e))t="undefined"!=typeof m[e]?c(m[e]):t;else if(r(e)){t=[];for(var o=0,i=e.length;i>o;o++)t.push(c(m[e[o]]))}else if(e===!0){t=[];for(var a in m)t.push(c(m[a]))}else t=c(m[g]);return t},this.createContext=function(e,t){var n,r,o=m[t]||m[this.getActiveEnvironment()];s.validate(e,o),r=o.context,n=s.create(e),r.splice(a(r,n),0,n)},this.createEnvironment=function(e,t){var n,r="undefined"!=typeof t?t:d;l.validate(e,m),n=l.create(e),m[e.name]=n,this.createContext({name:h},e.name),r!==!1&&(n.context[0].shortcut=this.toJSON(r))},this.createShortcut=function(e,t){var n=m[this.getActiveEnvironment()],r=f(n.context,t),o=n.context[r].shortcut;e.key=u.getKeyName(e.key),u.validate(e,o),o[e.key]=u.create(e)},this.createEnvironment({name:g}),y.addEventListener("blur",function(){b.clear()}),y.addEventListener("keyup",function(n){for(var r=n.keyCode?n.keyCode:n.which,o="undefined"!=typeof t[r]?t[r].toUpperCase():String.fromCharCode(r),i=0,a=e.length;a>i;i++){var f=e[i];n[f+"Key"]||b.keyUp(f.toUpperCase())}b.keyUp(o)},!1),y.addEventListener("keydown",function(n){var r,o=n.keyCode?n.keyCode:n.which,a="undefined"!=typeof t[o]?t[o].toUpperCase():String.fromCharCode(o),f=m[g];if(b.keyDown(a),-1===e.indexOf(a.toLowerCase()))for(var c=0,u=e.length;u>c;c++){var s=e[c];n[s+"Key"]&&b.keyDown(s.toUpperCase())}r=b.getKeys();for(var l=f.context.length-1;l>=0;l--){var d=f.context[l].shortcut[r];if(d&&!d.disabled){n.preventDefault(),n.stopPropagation(),v&&i(d),d.callback(n,arguments);break}}},!1)}});